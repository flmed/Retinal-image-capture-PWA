<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>Retina Capture PWA</title>
 
 <link rel="manifest" href="manifest.json">
 <meta name="theme-color" content="#ffffff">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black">
 <link rel="stylesheet" href="style.css" />
</head>
<body>

 <main>
  <nav id="step-nav">
   <div class="step" data-step="1">1. Info</div>
   <div class="step" data-step="2">2. Capture</div>
   <div class="step" data-step="3">3. Review</div>
   <div class="step" data-step="4">4. Analysis</div>
   <div class="step" data-step="5">5. TLX</div>
   <div class="step" data-step="6">6. Overview</div>
  </nav>

  <div class="page-container">
   <section id="page-basic" class="page active" data-page="1">
    <h2>Quick Tips</h2>
    
    <div class="info-tips-grid">
        <div class="tip-item">
            <span class="tip-icon">üì∏</span>
            <p>Ensure good lighting for clear focus during capture.</p>
        </div>
        <div class="tip-item">
            <span class="tip-icon">‚è±Ô∏è</span>
            <p>Auto-capture runs periodically only when actively detecting.</p>
        </div>
        <div class="tip-item">
            <span class="tip-icon">üîÑ</span>
            <p>Toggle the LEFT/RIGHT eye selection before capturing.</p>
        </div>
    </div>
    
    <div id="model-status-info-page" class="model-status-info-page">
        <p><strong>Model Loading Status:</strong></p>
        
        <div id="obj-det-status" class="model-status-item">
            <i class="status-circle fas fa-circle-notch fa-spin orange" data-status-key="objectDetection"></i>
            <span>Auto Capture Object Detection Model: <span class="status-text">Loading...</span></span>
        </div>
        
        <div id="classifier-status" class="model-status-item">
            <i class="status-circle fas fa-circle-notch fa-spin orange" data-status-key="classifier"></i>
            <span>Optic Disc Edema Classification Model: <span class="status-text">Loading...</span></span>
        </div>
    </div>

    <label for="operatorId">Operator ID (Required):</label>
    <input type="text" id="operatorId" placeholder="Enter Operator ID"/>
    
    <label for="subjectId">Subject ID (Required):</label>
    <input type="text" id="subjectId" placeholder="Enter unique ID"/>

    <div class="nav-controls fixed-bottom-controls single-button">
     <button id="toCaptureBtn" class="primary-btn">TO CAPTURE</button>
    </div>
   </section>

<section id="page-capture" class="page" data-page="2">
    <div class="camera-container">
     <video id="cameraFeed" autoplay playsinline></video>
     <canvas id="boundingBoxCanvas"></canvas>
     
     <button id="optionsBtn" class="options-btn">CAMERA SETTINGS</button>
     
     <div id="cameraOptionsPanel" class="camera-options-panel" style="display:none;">
        <h3>Camera Settings</h3>
        <div class="setting-item">
            <label for="cameraSelector">Select Camera:</label>
            <select id="cameraSelector"></select>
        </div>
        <div class="setting-item">
            <label for="torchToggle">Flash/LED:</label>
            <button id="torchToggleBtn" class="primary-btn">ON</button>
        </div>
        <button id="closeOptionsBtn" class="primary-btn">Close</button>
    </div>

     <div class="controls-row video-controls-overlay">
        
        <div class="controls-row-counter">
            <div id="imageCountOverlay" class="image-count-overlay">LEFT: 0 | RIGHT: 0</div>
        </div>
        
        <!-- OD detection on/off toggle -->
        <div class="controls-row-top" style="justify-content: flex-end; width: 100%;">
        <label for="odDetectionToggle" class="od-toggle-label">
            <input type="checkbox" id="odDetectionToggle" class="od-toggle-input" />
            <span class="od-toggle-slider"></span>
            <span class="od-toggle-text">OD DETECTION</span>
        </label>
        </div>
        <div class="controls-row-buttons">
            <button id="autoCaptureToggleBtn" class="control-btn secondary-btn">AUTO CAPTURE (INACTIVE)</button> 
            
            <div class="eye-toggle-container control-btn">
              <button id="eyeToggleLeft" class="toggle-side-btn secondary-btn" data-eye="LEFT">LEFT</button>
              <button id="eyeToggleRight" class="toggle-side-btn primary-btn active" data-eye="RIGHT">RIGHT</button>
            </div>
            
            <button id="manualCaptureBtn" class="control-btn primary-btn">MANUAL CAPTURE</button>
        </div>
     </div>
    </div>

    <div id="cameraOptionsPanel" class="camera-options-panel" style="display:none;">
        <h3>Camera Settings</h3>
        <div class="setting-item">
            <label for="cameraSelector">Select Camera:</label>
            <select id="cameraSelector"></select>
        </div>
        <div class="setting-item">
            <label for="torchToggle">Flash/LED:</label>
            <button id="torchToggleBtn" class="primary-btn">ON</button>
        </div>
        <button id="closeOptionsBtn" class="primary-btn">Close</button>
    </div>
    
    <div id="carousel-container">
     <div id="carousel">
      </div>
    </div>
    
    <div class="nav-controls fixed-bottom-controls">
      <button id="backFromCaptureBtn" class="secondary-btn">BACK</button>
      <button id="toReviewBtnBottom" class="primary-btn">REVIEW</button>
    </div>
    
   </section>

   <section id="page-review" class="page" data-page="3">
    <h2>Review Images</h2>

    <div class="review-controls-top">
     <button id="selectMultipleBtn" class="secondary-btn">Toggle Selection</button>
     <button id="clearAllImagesBtn" class="danger-btn">Clear All Images</button>
     <button id="deleteSelectedBtn" class="danger-btn" disabled>Delete Selected (0)</button>
    </div>

    <div class="split-gallery-container">
        <div class="gallery-column">
            <h3 id="left-eye-gallery-title">LEFT EYE (0)</h3>
            <div id="review-grid-left" class="review-grid"></div>
        </div>
        <div class="gallery-column">
            <h3 id="right-eye-gallery-title">RIGHT EYE (0)</h3>
            <div id="review-grid-right" class="review-grid"></div>
        </div>
    </div>
    
    <div class="nav-controls fixed-bottom-controls"> 
     <button id="backFromReviewBtn" class="secondary-btn">BACK</button>
     <button id="toAnalyzeBtn" class="primary-btn">TO ANALYZE</button>
    </div>

   </section>

   <section id="page-analysis" class="page" data-page="4">
    <h2>Image Analysis</h2>
    <p class="analysis-subtitle">Top 5 images from each eye selected for analysis.</p>

    <div class="analysis-section">
        <h3>LEFT EYE IMAGES</h3>
        <div id="analysis-grid-left" class="analysis-grid"></div>
        <div id="analysis-result-left" class="analysis-result" style="display: none;"></div>
    </div>
    
    <div class="analysis-section">
        <h3>RIGHT EYE IMAGES</h3>
        <div id="analysis-grid-right" class="analysis-grid"></div>
        <div id="analysis-result-right" class="analysis-result" style="display: none;"></div>
    </div>
    
    <button id="runAnalysisBtn" class="primary-btn wide-btn">RUN ANALYSIS</button>

    <div class="nav-controls fixed-bottom-controls"> 
     <button id="backFromAnalysisBtn" class="secondary-btn">BACK</button>
     <button id="toQuestionnaireBtn" class="primary-btn">TO QUESTIONNAIRE</button>
    </div>
   </section>

   <section id="page-questionnaire" class="page" data-page="5">
    <h2>NASA TLX Questionnaire</h2>
    <div class="nasa-tlx-questions">
     </div>

    <label for="comments">Comments:</label>
    <textarea id="comments" rows="3"></textarea>

    <div class="nav-controls fixed-bottom-controls">
     <button id="backFromQuestionnaireBtn" class="secondary-btn">BACK</button>
     <button id="toOverviewBtn" class="primary-btn">TO OVERVIEW</button> </div>
   </section>

   <section id="page-overview" class="page" data-page="6">
        <h2>Session Overview</h2>

        <div class="overview-section">
            <h3>SESSION DETAILS</h3>
            <p><strong>Operator ID:</strong> <span id="overviewOperatorId">N/A</span></p>
            <p><strong>Subject ID:</strong> <span id="overviewSubjectId">N/A</span></p>
        </div>

        <div class="overview-section">
            <h3>IMAGE REVIEW</h3>
            <div class="review-carousel-group">
                <div class="overview-image-section">
                    <h4>LEFT EYE (<span id="overviewLeftCount">0</span>)</h4>
                    <div id="overview-carousel-left" class="overview-carousel analysis-grid"></div>
                </div>
                <div class="overview-image-section">
                    <h4>RIGHT EYE (<span id="overviewRightCount">0</span>)</h4>
                    <div id="overview-carousel-right" class="overview-carousel analysis-grid"></div>
                </div>
            </div>
        </div>
        
        <div class="overview-section">
            <h3>ANALYSIS RESULTS</h3>
            <div id="overview-analysis-left" class="analysis-result"></div>
            <div id="overview-analysis-right" class="analysis-result"></div>
        </div>

        <div class="overview-section">
            <h3>NASA TLX & Comments</h3>
            <div id="overview-tlx-results" class="nasa-tlx-questions">
                </div>
            <p><strong>Comments:</strong> <span id="overviewComments">No comments provided.</span></p>
        </div>
        
    <div class="controls-row page-footer-controls">
        <button id="backFromOverviewBtn" class="secondary-btn">BACK</button>
        <button id="submitSessionBtn" class="primary-btn">SUBMIT SESSION</button>
    </div>
   </section>
   </div>
 </main>

 <div id="modal-overlay" class="modal-overlay" style="display: none;">
  <div class="modal-content">
   <h3>Submission Complete!</h3>
   <p>The captured images and questionnaire results have been successfully saved.</p>
   <div class="modal-actions">
    <button id="continueSessionBtn" class="secondary-btn">Continue Session</button>
    <button id="newSessionBtn" class="primary-btn">Start New Session</button>
   </div>
  </div>
 </div>

<div id="lightbox-overlay" style="display: none;">
    <span id="lightbox-close">&times;</span>
    <div id="lightbox-prev" class="lightbox-nav">&#10094;</div>
    <img id="lightbox-image" src="" alt="Enlarged view">
    <div id="lightbox-next" class="lightbox-nav">&#10095;</div>
    <div class="lightbox-actions">
        <button id="lightboxSelectBtn" class="secondary-btn">Select</button>
        <div id="lightbox-info"></div> 
        <button id="lightboxDeleteBtn" class="danger-btn">Delete</button>
    </div>
 </div>

 <script type="module" src="script.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://kit.fontawesome.com/a688a7bff8.js" crossorigin="anonymous"></script>
 
 <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }
 </script>
</body>
</html>